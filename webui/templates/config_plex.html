{% extends "base.html" %}
{% block content %}
<section class="config">
  <h2>ğŸ¬ Plex Configuration</h2>
  <p class="desc">
    Manage your Plex integration, access mode, and connected libraries.<br>
    These values are read from <code>config/config.ini</code>.
  </p>

  <form method="post" class="config-form">
    <!-- â”€â”€â”€â”€â”€â”€ PLEX SETTINGS â”€â”€â”€â”€â”€â”€ -->
    <div class="config-section">
      <h3>ğŸ”‘ Plex Server Connection</h3>
      <div class="form-grid">
        <label>
          <span>Plex URL</span>
          <input type="text" name="URL" value="{{ config.get('URL', '') }}" placeholder="http://192.168.x.x:32400">
        </label>
        <label>
          <span>Plex Token</span>
          <input type="password" name="Token" value="{{ config.get('Token', '') }}" placeholder="YOUR_PLEX_TOKEN_HERE">
        </label>
      </div>

      <div class="form-grid">
        <label>
          <span>Libraries (comma-separated)</span>
          <input type="text" name="Libraries" value="{{ config.get('Libraries', '') }}" placeholder="Movies, TV Shows">
        </label>
      </div>
      <button type="submit" class="btn btn-primary">ğŸ’¾ Save Changes</button>
      <button type="button" class="btn" id="testPlex">ğŸ” Test Plex Connection</button>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€ TEST RESULT AREA â”€â”€â”€â”€â”€â”€ -->
    <div id="plexTestResult" class="test-result" style="margin-top: 10px;"></div>
  </form>
</section>

<script>
document.getElementById("testPlex").addEventListener("click", async () => {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = "Testingâ€¦";

  try {
    const res = await fetch("/config/plex/test", { method: "POST" });
    const data = await res.json();
    const box = document.getElementById("plexTestResult");

    if (data.status === "ok") {
      box.innerHTML = `âœ… Connected successfully to <b>${data.server}</b> (${data.libraries.length} libraries)`;
      box.style.color = "var(--accent)";
    } else {
      box.innerHTML = `âŒ Connection failed: ${data.error}`;
      box.style.color = "red";
    }
  } catch (err) {
    document.getElementById("plexTestResult").innerText = "âš ï¸ Test failed: " + err;
  } finally {
    btn.disabled = false;
    btn.textContent = "ğŸ” Test Plex Connection";
  }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<section class="status">
  <h2>System: Status</h2>
  <p>Overview of the Casharr backend, connected services, and runtime information.</p>

  <!-- System Overview -->
  <div class="grid">
    <div class="card">
      <h3>Overview</h3>
      <table class="status-table">
        <tr><td><strong>Bot Status</strong></td><td id="discordStatus">Checking…</td></tr>
        <tr><td><strong>Plex Connection</strong></td><td id="plexStatus">Checking…</td></tr>
        <tr><td><strong>Flask WebUI</strong></td><td>✅ Running</td></tr>
        <tr><td><strong>Schema Version</strong></td><td id="schemaVersion">—</td></tr>
        <tr><td><strong>Next Backup</strong></td><td id="nextBackup">—</td></tr>
        <tr><td><strong>Uptime</strong></td><td id="uptime">—</td></tr>
        <tr><td><strong>System Time</strong></td><td id="systemTime">—</td></tr>
      </table>
    </div>

    <div class="card">
      <h3>Storage</h3>
      <div id="diskSection">
        <div class="disk-bar">
          <div id="diskUsed" class="disk-used"></div>
        </div>
        <p><span id="diskUsage">—</span></p>
      </div>
    </div>
  </div>

  <!-- About Section -->
  <div class="card mt">
    <h3>About Casharr</h3>
    <table class="status-table">
      <tr><td><strong>Version</strong></td><td>{{ version or "1.0.0" }}</td></tr>
      <tr><td><strong>Build</strong></td><td>Custom Docker Build (Self-Hosted)</td></tr>
      <tr><td><strong>Language</strong></td><td>Python 3.12</td></tr>
      <tr><td><strong>Framework</strong></td><td>Flask + Discord.py</td></tr>
      <tr><td><strong>Database</strong></td><td>SQLite 3</td></tr>
      <tr><td><strong>Database Path</strong></td><td>/data/members.db</td></tr>
      <tr><td><strong>AppData Directory</strong></td><td>/config</td></tr>
      <tr><td><strong>Startup Directory</strong></td><td>/app/casharr</td></tr>
      <tr><td><strong>Mode</strong></td><td>Console + WebUI</td></tr>
      <tr><td><strong>Maintainer</strong></td><td>Aquilla Computing Systems</td></tr>
    </table>
  </div>

  <!-- More Info -->
  <div class="card mt">
    <h3>More Info</h3>
    <ul class="info-links">
      <li><a href="TBA" target="_blank">Home Page</a></li>
      <li><a href="https://github.com/Aquillacomputingsystem/casharr" target="_blank">Wiki</a></li>
      <li><a href="https://github.com/Aquillacomputingsystem/casharr" target="_blank">Forums</a></li>
      <li><a href="TBA" target="_blank">Twitter</a></li>
      <li><a href="TBA" target="_blank">Discord</a></li>
      <li><a href="https://github.com/Aquillacomputingsystem/casharr" target="_blank">IRC / Libera</a></li>
      <li><a href="paypal.me/justinkurban" target="_blank">Donations</a></li>
      <li><a href="https://github.com/Aquillacomputingsystem/casharr" target="_blank">Source Code</a></li>
      <li><a href="https://github.com/Aquillacomputingsystem/casharr" target="_blank">Feature Requests</a></li>
    </ul>
  </div>
</section>

<style>
.status h2 { margin-bottom: .5rem; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; margin-top: 1rem; }
.mt { margin-top: 1.5rem; }
.status-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.status-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.status-table td:first-child { color: var(--text-muted); width: 40%; }
.disk-bar { width: 100%; height: 18px; background: var(--bg-elev); border-radius: var(--radius); overflow: hidden; margin-top: .5rem; }
.disk-used { height: 100%; width: 0%; background: var(--accent, #4caf50); transition: width .8s ease; }
.info-links { list-style: none; padding: 0; margin: 0; font-size: 14px; }
.info-links li { margin: .25rem 0; }
.info-links a { color: var(--accent); text-decoration: none; }
.info-links a:hover { text-decoration: underline; }
</style>

<script>
async function fetchStatus() {
  try {
    const [statusRes, schemaRes] = await Promise.all([
      fetch('/api/status'),
      fetch('/api/schema')
    ]);
    const data = await statusRes.json();
    const schema = await schemaRes.json();

    // Discord
    document.getElementById('discordStatus').textContent =
      data.discord_online ? "✅ Connected" : "❌ Offline";

    // Plex
    document.getElementById('plexStatus').textContent =
      data.plex_connected ? "✅ Connected" : "❌ Unavailable";

    // Uptime & time
    document.getElementById('uptime').textContent = data.uptime || '—';
    document.getElementById('systemTime').textContent = new Date().toLocaleString();

    // Disk usage
    const disk = document.getElementById('diskUsed');
    const usage = document.getElementById('diskUsage');
    if (data.disk && data.disk.percent !== undefined) {
      disk.style.width = data.disk.percent + '%';
      usage.textContent = `${data.disk.used} / ${data.disk.total} (${data.disk.percent}%)`;
    }

    // Schema + backup
    document.getElementById('schemaVersion').textContent = schema.schema_version ?? '—';
    document.getElementById('nextBackup').textContent = schema.next_backup ? new Date(schema.next_backup).toLocaleString() : '—';

  } catch (err) {
    console.error('Error fetching system status:', err);
  }
}

fetchStatus();
setInterval(fetchStatus, 15000);
</script>
{% endblock %}

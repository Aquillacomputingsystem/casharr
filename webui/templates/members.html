{% extends "base.html" %}
{% block content %}
<section class="members">
  <div class="header-row">
    <h2>üë• Members</h2>
    <div class="actions">
      <input id="searchInput" class="search" placeholder="Search name, email, or status‚Ä¶" />
      <button id="refreshBtn" class="btn">‚ü≥ Refresh</button>
      <button id="addBtn" class="btn btn-primary">Ôºã Add / Update</button>
      <button class="btn btn-sm btn-primary" onclick="openInviteModal()">Invite Member</button>
      <button class="btn btn-sm btn-secondary" onclick="forceSyncAccess()">Force Re-check</button>
      <form action="/api/sync/plex" method="post" style="display:inline">
        <button class="btn btn-primary">üîÑ Sync All from Plex</button>
      </form>
      <button id="dmAllBtn" class="btn">üì¢ DM All</button>
    </div>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Status</th>
          <th>Referrer</th>
          <th style="width:150px;">Actions</th>
        </tr>
      </thead>
      <tbody id="membersBody">
        <tr><td colspan="6">Loading members...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<!-- Add / Update Member Modal -->
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="modal" class="modal hidden">
  <div class="modal__card">
    <header class="modal__head">
      <h3>Add / Update Member</h3>
      <button id="modalClose" class="icon-btn" title="Close">‚úï</button>
    </header>
    <div class="modal__body">
      <div class="grid">
        <label><span>Discord ID</span><input id="m_discord_id" placeholder="123456789012345678"></label>
        <label><span>Discord Tag</span><input id="m_discord_tag" placeholder="username#1234"></label>
        <label><span>First Name</span><input id="m_first" placeholder="First"></label>
        <label><span>Last Name</span><input id="m_last" placeholder="Last"></label>
        <label class="span-2"><span>Email</span><input id="m_email" placeholder="plex@example.com"></label>
        <label class="span-2"><span>Mobile</span><input id="m_mobile" placeholder="+61‚Ä¶"></label>
      </div>
    </div>
    <footer class="modal__foot">
      <button id="modalSave" class="btn btn-primary">Save</button>
      <button id="modalCancel" class="btn">Cancel</button>
    </footer>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DM Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="dmModal" class="modal hidden">
  <div class="modal__card" style="max-width:700px;">
    <header class="modal__head">
      <h3 id="dmModalTitle">Send Message</h3>
      <button class="icon-btn" onclick="closeDMModal()">‚úï</button>
    </header>

    <div class="modal__body" style="display:flex;flex-direction:column;gap:12px;">
      <div id="dmGroupSelect" class="hidden">
        <label style="font-weight:600;">Send To</label>
        <div class="group-select">
          <label><input type="checkbox" class="groupCheck" value="trial"> Trial</label>
          <label><input type="checkbox" class="groupCheck" value="payer"> Payer</label>
          <label><input type="checkbox" class="groupCheck" value="lifetime"> Lifetime</label>
          <label><input type="checkbox" class="groupCheck" value="expired"> Expired</label>
        </div>
      </div>

      <label style="font-weight:600;">Subject</label>
      <input type="text" id="dmSubject" placeholder="Enter subject‚Ä¶" class="input-wide">

      <label style="font-weight:600;">Message</label>
      <textarea id="dmBody" rows="8" placeholder="Type your message‚Ä¶" class="input-wide"></textarea>

      <div class="options-row">
        <label><input type="checkbox" id="dmPayLink"> Include PayLink</label>
      </div>

      <div class="channel-select">
        <label><input type="checkbox" id="dmDiscord" checked> Discord</label>
        <label><input type="checkbox" id="dmEmail" checked> Email</label>
        <label><input type="checkbox" id="dmSMS"> SMS</label>
      </div>
    </div>

    <footer class="modal__foot">
      <button class="btn btn-primary" onclick="sendDM()">Send</button>
      <button class="btn" onclick="closeDMModal()">Cancel</button>
    </footer>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ View Member Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="viewModal" class="modal hidden">
  <div class="modal__card" style="max-width:600px;">
    <header class="modal__head">
      <h3 id="viewTitle">Member Details</h3>
      <button class="icon-btn" onclick="closeViewModal()">‚úï</button>
    </header>
    <div class="modal__body" id="viewBody">Loading...</div>
    <footer class="modal__foot">
      <button class="btn" onclick="closeViewModal()">Close</button>
    </footer>
  </div>
</div>

<style>
.members .header-row {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;gap:12px;
}
.members .header-row h2 {
  font-size:1.4rem;font-weight:600;color:var(--text);
}
.members .actions {display:flex;gap:8px;align-items:center;}
.table-wrap {overflow:auto;border-radius:var(--radius);background:var(--bg-elev);box-shadow:var(--shadow-sm);}
.table {width:100%;border-collapse:collapse;}
.table th,.table td {padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;}
.table th {background:var(--bg-elev);color:var(--text-muted);font-weight:600;font-size:14px;}
.table tbody tr:hover {background:rgba(0,200,150,0.05);}
.theme-dark .table tbody tr:hover {background:rgba(0,200,150,0.08);}
.clickable-name{cursor:pointer;color:var(--accent);font-weight:500;}
.clickable-name:hover{text-decoration:underline;}
.status-pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:500;}
.status-trial{background:#fff7e6;color:#8a6d3b;}
.status-payer{background:#e8fff6;color:#2b7a54;}
.status-life{background:#e6f0ff;color:#2952a3;}
.status-exp{background:#ffeaea;color:#a33a3a;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:grid;place-items:center;z-index:50;}
.modal.hidden{display:none;}
.modal__card{width:min(650px,95vw);background:var(--bg);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow-md);overflow:hidden;}
.modal__head,.modal__foot{padding:12px 16px;background:var(--bg-elev);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.modal__foot{border-top:1px solid var(--border);border-bottom:none;justify-content:flex-end;gap:8px;}
.modal__body{padding:16px;}
.icon-btn{border:1px solid var(--border);background:var(--bg-elev);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:13px;}
.icon-btn:hover{filter:brightness(1.05);}
.icon-btn.danger{background:#ffefef;color:#a00000;}
.action-bar{display:flex;gap:6px;}
.input-wide{width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg-elev);color:var(--text);}
</style>

<script>
const $body=document.getElementById('membersBody');
const $search=document.getElementById('searchInput');
const $refresh=document.getElementById('refreshBtn');
const $add=document.getElementById('addBtn');
const $modal=document.getElementById('modal');
const $close=document.getElementById('modalClose');
const $cancel=document.getElementById('modalCancel');
const $save=document.getElementById('modalSave');
const $dmAllBtn=document.getElementById('dmAllBtn');

const $id=document.getElementById('m_discord_id');
const $tag=document.getElementById('m_discord_tag');
const $first=document.getElementById('m_first');
const $last=document.getElementById('m_last');
const $email=document.getElementById('m_email');
const $mobile=document.getElementById('m_mobile');

let cache=[];let dmTarget=null;

function statusPill(s){
  const cls=s==='Trial'?'status-trial':s==='Payer'?'status-payer':s==='Lifetime'?'status-life':s==='Expired'?'status-exp':'';
  return `<span class="status-pill ${cls}">${s||'-'}</span>`;
}
function renderRows(list){
  if(!list.length){$body.innerHTML='<tr><td colspan="6">No members found.</td></tr>';return;}
  $body.innerHTML=list.map(m=>`
    <tr data-id="${m.discord_id}">
      <td class="clickable-name">${m.first_name||'-'} ${m.last_name||''}</td>
      <td>${m.email||'-'}</td>
      <td>${m.mobile||'-'}</td>
      <td>
      <select class="status-select" data-id="${m.discord_id}">
      ${(ROLE_OPTIONS.length ? ROLE_OPTIONS : ['Initial','Trial','Payer','Lifetime','Expired'])
        .map(r => `<option value="${r}" ${m.status===r?'selected':''}>${r}</option>`)
        .join('')}
      </select>
      </td>
      <td>${m.referrer_id||'-'}</td>
      <td><div class="action-bar">
        <button class="icon-btn js-view" title="View Details">üëÅÔ∏è</button>
        <button class="icon-btn js-dm" title="Message">üì©</button>
        <button class="icon-btn js-paid" title="Mark Paid">üí∞</button>
        <button class="icon-btn js-trial" title="Extend Trial">‚è≥</button>
        <button class="icon-btn js-remove danger" title="Remove">‚úñ</button>
      </div></td>
    </tr>`).join('');
}
    let ROLE_OPTIONS = [];
    fetch('/api/roles').then(r=>r.json()).then(j=>{
      if (j.ok && Array.isArray(j.roles)) {
        ROLE_OPTIONS = j.roles;
        // re-render if data already loaded
        if (cache.length) applyFilter();
      }
    });
async function loadMembers(){
  try{
    const res=await fetch('/api/members');
    const data=await res.json();
    cache=data.members||[];
    applyFilter();
  }catch{ $body.innerHTML='<tr><td colspan="6">‚ö†Ô∏è Failed to load members.</td></tr>'; }
}
function applyFilter(){
  const q=$search.value.trim().toLowerCase();
  const f=!q?cache:cache.filter(m=>
    (m.first_name||'').toLowerCase().includes(q)||
    (m.last_name||'').toLowerCase().includes(q)||
    (m.email||'').toLowerCase().includes(q)||
    (m.status||'').toLowerCase().includes(q)
  );
  renderRows(f);
}
$search.addEventListener('input',applyFilter);
$refresh.addEventListener('click',loadMembers);

// Modal actions
$add.addEventListener('click',()=> $modal.classList.remove('hidden'));
[$close,$cancel].forEach(b=>b.addEventListener('click',()=> $modal.classList.add('hidden')));
$save.addEventListener('click',async()=>{
  const payload={discord_id:$id.value,discord_tag:$tag.value,first_name:$first.value,last_name:$last.value,email:$email.value,mobile:$mobile.value};
  try{
    const res=await fetch('/api/member',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await res.json();if(!j.ok)throw new Error(j.error||'Save failed');
    $modal.classList.add('hidden');loadMembers();
  }catch(e){alert('‚ùå '+e.message);}
});

$body.addEventListener('click',e=>{
  const v=e.target.closest('.js-view');
  const dm=e.target.closest('.js-dm');
  const paid = e.target.closest('.js-paid');
  const trial = e.target.closest('.js-trial');
  if (paid) return markPaid(id);
  if (trial) return extendTrial(id);
  const del=e.target.closest('.js-remove');
  const tr=e.target.closest('tr');if(!tr)return;const id=tr.dataset.id;
  if(v)return openViewModal(id);
  if(dm)return openDMModal(id,tr.querySelector('td').textContent);
  if(del){if(confirm('Remove Plex + downgrade to No Access?'))removeMember(id);}
});

function removeMember(discordId, email) {
  if (!confirm("Are you sure you want to remove this member?")) return;

  const formData = new FormData();

  // Always include email if known
  if (email && email.trim() !== "") formData.append("email", email);

  // Handle "noid" or missing IDs by explicitly setting to 'noid'
  const safeId = discordId && discordId.trim() !== "" ? discordId : "noid";

  fetch(`/api/member/${safeId}/delete`, {
    method: "POST",
    body: formData
  })
    .then((res) => res.json())
    .then((data) => {
      if (data.ok) {
        // ‚úÖ Reload table instantly after successful delete
        loadMembers();
      } else {
        alert(data.error || "Failed to remove member.");
      }
    })
    .catch((err) => {
      console.error("Delete failed:", err);
      alert("Error deleting member. See console for details.");
    });
}



async function openViewModal(id){
  const modal=document.getElementById('viewModal');
  modal.classList.remove('hidden');
  const body=document.getElementById('viewBody');
  body.innerHTML='Loading...';
  try{
    const res=await fetch(`/api/member/${id}`);
    const j=await res.json();
    if(!j.ok)throw new Error(j.error);
    const m=j.member;
    body.innerHTML=`
      <p><b>Discord ID:</b> ${m.discord_id||'-'}</p>
      <p><b>Discord Tag:</b> ${m.discord_tag||'-'}</p>
      <p><b>Email:</b> ${m.email||'-'}</p>
      <p><b>Mobile:</b> ${m.mobile||'-'}</p>
      <p><b>Trial End:</b> ${m.trial_end||'-'}</p>
      <p><b>Paid Until:</b> ${m.paid_until||'-'}</p>
      <p><b>Referrer:</b> ${m.referrer_id||'-'}</p>
      <p><b>Origin:</b> ${m.origin||'-'}</p>
      <p><b>Status:</b> ${m.status||'-'}</p>
    `;
  }catch(e){body.innerHTML='‚ö†Ô∏è '+e.message;}
}
function closeViewModal(){document.getElementById('viewModal').classList.add('hidden');}

// DM modal integration
let isBroadcast=false;
function openDMModal(id,name){
  dmTarget=id;isBroadcast=(id==='all');
  document.getElementById('dmModalTitle').textContent=isBroadcast?'Broadcast Message':`Send Message to ${name}`;
  document.getElementById('dmModal').classList.remove('hidden');
  document.getElementById('dmGroupSelect').classList.toggle('hidden',!isBroadcast);
}
function closeDMModal(){document.getElementById('dmModal').classList.add('hidden');}
async function sendDM(){
  const subject=document.getElementById('dmSubject').value.trim();
  const body=document.getElementById('dmBody').value.trim();
  const includePayLink=document.getElementById('dmPayLink').checked;
  const discord=document.getElementById('dmDiscord').checked;
  const email=document.getElementById('dmEmail').checked;
  const sms=document.getElementById('dmSMS').checked;
  let groups=[];
  if(isBroadcast){
    document.querySelectorAll('.groupCheck:checked').forEach(c=>groups.push(c.value));
    if(!groups.length){alert('Select at least one member group.');return;}
  }
  try{
    const res=await fetch(`/api/message/${dmTarget}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({subject,body,includePayLink,discord,email,sms,groups})
    });
    const data=await res.json();
    alert(data.ok?`‚úÖ Sent ${data.sent_count} messages.`:`‚ö†Ô∏è ${data.error}`);
    closeDMModal();
  }catch(err){alert('‚ö†Ô∏è '+err.message);}
}
$dmAllBtn.addEventListener('click',()=>openDMModal('all','All Members'));

loadMembers();
</script>
<!-- üì® Invite Modal -->
<div id="inviteModal" class="modal" style="display:none;">
  <div class="modal-content" style="padding:20px;max-width:400px;">
    <h3>Invite Member</h3>
    <label>Email:</label><br>
    <input id="inviteEmail" type="email" placeholder="user@example.com" style="width:100%;margin-bottom:8px;">
    <label>Mobile:</label><br>
    <input id="inviteMobile" type="text" placeholder="+61..." style="width:100%;margin-bottom:8px;">
    <div style="margin-top:10px;text-align:right;">
      <button onclick="sendInvite()">Send</button>
      <button onclick="closeModal('inviteModal')">Cancel</button>
    </div>
  </div>
</div>

<script>
function openInviteModal(){ document.getElementById('inviteModal').style.display='block'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

async function sendInvite(){
  const email = document.getElementById('inviteEmail').value.trim();
  const mobile = document.getElementById('inviteMobile').value.trim();
  const res = await fetch('/api/invite', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({email, mobile})
  });
  const data = await res.json();
  alert(data.ok ? '‚úÖ Invite sent successfully!' : '‚ùå Error: ' + data.error);
  closeModal('inviteModal');
}

async function forceSyncAccess(){
  if(!confirm('Force Plex/Discord re-check?')) return;
  const res = await fetch('/api/sync_access',{method:'POST'});
  const data = await res.json();
  alert(data.ok ? data.message : '‚ùå Error: ' + data.error);
}
async function markPaid(discordId){
  if(!confirm("Mark this member as paid for 30 days?")) return;
  const res=await fetch(`/api/member/${discordId}/mark_paid`,{method:'POST'});
  const data=await res.json();
  alert(data.ok ? "‚úÖ " + data.message : "‚ùå " + data.error);
  loadMembers();
}

async function extendTrial(discordId){
  if(!confirm("Extend this member's trial by 7 days?")) return;
  const res=await fetch(`/api/member/${discordId}/extend_trial`,{method:'POST'});
  const data=await res.json();
  alert(data.ok ? "‚úÖ " + data.message : "‚ùå " + data.error);
  loadMembers();
}
$body.addEventListener("change", async (e) => {
  const select = e.target.closest(".status-select");
  if (!select) return;

  const id = select.dataset.id;
  const newStatus = select.value;

  if (!confirm(`Change this member's status to ${newStatus}?`)) {
    loadMembers();
    return;
  }

  try {
    const res = await fetch(`/api/member/${id}/set_status`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus }),
    });
    const data = await res.json();
      if (data.ok) {
        alert("‚úÖ " + data.message);
        // update UI instantly without reload
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
          const cell = row.querySelector(".status-select");
          if (cell) cell.value = newStatus;
        }
      } else {
        alert("‚ùå " + data.error);
      }
      setTimeout(loadMembers, 1000);

  } catch (err) {
    alert("‚ö†Ô∏è Failed to update status: " + err.message);
  }
});

</script>

{% endblock %}

